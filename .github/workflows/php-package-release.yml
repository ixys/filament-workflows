name: PHP Package - Tests & Release

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  artifacts: write
  packages: write  # n√©cessaire pour GitHub Packages / GHCR

env:
  PACKAGE_NAME: "ixys/filament-workflows"

jobs:
  tests:
    name: Run tests (PHP)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.4']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, intl, pdo, pdo_mysql
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: ${{ runner.os }}-php-${{ matrix.php-version }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-${{ matrix.php-version }}-composer-

      - name: Validate composer.json and composer.lock
        run: composer validate --strict

      - name: Install dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run tests
        run: |
          if [ -f vendor/bin/phpunit ]; then
            echo "Running tests with PHPUnit..."
            vendor/bin/phpunit
          elif [ -f vendor/bin/pest ]; then
            echo "Running tests with Pest..."
            vendor/bin/pest
          elif composer show-scripts 2>/dev/null | grep -q "^  test"; then
            echo "Running tests with composer test..."
            composer test
          else
            echo "‚ö†Ô∏è No test configuration found (phpunit, pest, or composer test script)."
            echo "Skipping tests..."
            exit 0
          fi

  build-package:
    name: Build package archive
    runs-on: ubuntu-latest
    needs: tests
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, intl

      - name: Install prod dependencies
        run: |
          composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      - name: Build ZIP artifact
        run: |
          mkdir -p dist
          
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF_NAME#v}
          ZIP_NAME="filament-workflows-${VERSION}.zip"

          echo "Creating release package: ${ZIP_NAME}"

          # Create archive with production dependencies included
          zip -r "dist/${ZIP_NAME}" . \
            -x ".git/*" \
               ".github/*" \
               "tests/*" \
               "dist/*" \
               "node_modules/*" \
               ".gitignore" \
               ".gitattributes" \
               "*.log"

          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
          echo "ZIP_PATH=dist/${ZIP_NAME}" >> $GITHUB_ENV
          echo "‚úÖ Release package created: dist/${ZIP_NAME}"
          ls -lh "dist/${ZIP_NAME}"

      - name: Upload artifact (workflow only)
        uses: actions/upload-artifact@v4
        with:
          name: filament-workflows-${{ github.ref_name }}
          path: dist/*.zip
          retention-days: 90
          if-no-files-found: error

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: filament-workflows-${{ github.ref_name }}
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-packagist:
    name: Notify Packagist
    runs-on: ubuntu-latest
    needs: build-package
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Check if Packagist secrets are configured
        id: check-secrets
        run: |
          if [ -n "${{ secrets.PACKAGIST_USERNAME }}" ] && [ -n "${{ secrets.PACKAGIST_API_TOKEN }}" ]; then
            echo "secrets_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Packagist secrets are configured"
          else
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Packagist secrets not configured - skipping Packagist update"
          fi

      - name: Trigger Packagist update
        if: steps.check-secrets.outputs.secrets_available == 'true'
        run: |
          echo "Updating Packagist for ${{ env.PACKAGE_NAME }}..."

          # Create update URL with credentials (GitHub Actions masks secrets in logs)
          UPDATE_URL="https://packagist.org/api/update-package?username=${{ secrets.PACKAGIST_USERNAME }}&apiToken=${{ secrets.PACKAGIST_API_TOKEN }}"
          
          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST "$UPDATE_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "repository[url]=https://github.com/${{ github.repository }}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 202 ]; then
            echo "‚úÖ Packagist updated successfully"
            echo "$BODY"
          else
            echo "‚ö†Ô∏è Packagist update returned HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

  publish-github-packages:
    name: Publish to GitHub Packages (GHCR)
    runs-on: ubuntu-latest
    needs: build-package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      packages: write

    steps:
      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: filament-workflows-${{ github.ref_name }}
          path: dist

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1
        with:
          version: 1.2.2

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io \
            --username "${{ github.repository_owner }}" \
            --password-stdin

      - name: Publish package to GHCR
        run: |
          ZIP_FILE="$(ls dist/*.zip | head -n1)"

          if [ -z "$ZIP_FILE" ] || [ ! -f "$ZIP_FILE" ]; then
            echo "‚ùå No ZIP file found in dist/"
            exit 1
          fi

          # Use repository name for package
          REPO_NAME="${{ github.event.repository.name }}"
          TAG="${GITHUB_REF_NAME#v}"

          echo "üì¶ Publishing $ZIP_FILE to ghcr.io/${{ github.repository_owner }}/${REPO_NAME}:${TAG}"

          oras push "ghcr.io/${{ github.repository_owner }}/${REPO_NAME}:${TAG}" \
            --artifact-type "application/vnd.php.package+zip" \
            "$ZIP_FILE:application/zip"

          echo "‚úÖ Package published to GitHub Packages"
          echo "üìç Available at: ghcr.io/${{ github.repository_owner }}/${REPO_NAME}:${TAG}"
